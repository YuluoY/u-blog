#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import pkg from 'fast-glob';
const { glob } = pkg;

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * ç”ŸæˆVueå…¨å±€ç»„ä»¶ç±»å‹æ˜ å°„æ–‡ä»¶
 * æ‰«æsrc/componentsç›®å½•ä¸‹çš„æ‰€æœ‰ç»„ä»¶index.tsæ–‡ä»¶
 * ç”Ÿæˆç±»ä¼¼ucc-ui-components.d.tsçš„å…¨å±€å£°æ˜æ–‡ä»¶
 */

const SRC_COMPONENTS_DIR = path.join(__dirname, '../src/components');
const OUTPUT_FILE = path.join(__dirname, '../dist/u-blog-ui.d.ts');
/** ä¸»ç±»å‹å…¥å£ï¼Œéœ€å¼•ç”¨ u-blog-ui.d.ts æ‰èƒ½è®© instance.proxy æ‹¥æœ‰ $dialog ç­‰ç±»å‹ */
const CORE_INDEX_DTS = path.join(__dirname, '../dist/types/core/index.d.ts');
const U_BLOG_UI_REF = `/// <reference path="../../u-blog-ui.d.ts" />\n`;

/**
 * å°†ç»„ä»¶åè½¬æ¢ä¸ºPascalCase
 * @param {string} name ç»„ä»¶å
 * @returns {string} PascalCaseæ ¼å¼çš„ç»„ä»¶å
 */
function toPascalCase(name) {
  return name
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join('');
}

/**
 * æ‰«æç»„ä»¶å¯¼å‡º
 * @returns {Object} åŒ…å«ç»„ä»¶å’Œå‡½æ•°å¼ç»„ä»¶çš„å¯¹è±¡
 */
async function scanComponentExports() {
  const components = [];
  const functionComponents = [];
  
  // æ‰«ææ‰€æœ‰ç»„ä»¶çš„index.tsæ–‡ä»¶
  const indexFiles = await glob('*/index.ts', {
    cwd: SRC_COMPONENTS_DIR,
    absolute: false
  });

  for (const file of indexFiles) {
    const componentDir = path.dirname(file);
    const indexPath = path.join(SRC_COMPONENTS_DIR, file);
    
    try {
      const content = fs.readFileSync(indexPath, 'utf8');
      
      // æŸ¥æ‰¾æ‰€æœ‰export const Uå¼€å¤´çš„ç»„ä»¶ï¼ˆæ’é™¤ä»¥Fnç»“å°¾çš„å‡½æ•°å¼ç»„ä»¶ï¼‰
      const componentMatches = content.match(/export const (U[A-Z][a-zA-Z0-9]*)/g);
      if (componentMatches) {
        for (const match of componentMatches) {
          const componentName = match.replace('export const ', '');
          // æ’é™¤å‡½æ•°å¼ç»„ä»¶ï¼ˆä»¥Fnç»“å°¾ï¼‰
          if (!componentName.endsWith('Fn')) {
            components.push({
              name: componentName,
              componentDir: componentDir
            });
          }
        }
      }
      
      // æŸ¥æ‰¾æ‰€æœ‰export const Uå¼€å¤´çš„å‡½æ•°å¼ç»„ä»¶ï¼ˆä»¥Fnç»“å°¾ï¼‰
      const functionMatches = content.match(/export const (U[A-Z][a-zA-Z0-9]*Fn)/g);
      if (functionMatches) {
        for (const match of functionMatches) {
          const functionName = match.replace('export const ', '');
          functionComponents.push({
            name: functionName,
            componentDir: componentDir
          });
        }
      }
    } catch (error) {
      console.warn(`âš ï¸  æ— æ³•è¯»å–æ–‡ä»¶ ${indexPath}:`, error.message);
    }
  }

  return {
    components: components.sort((a, b) => a.name.localeCompare(b.name)),
    functionComponents: functionComponents.sort((a, b) => a.name.localeCompare(b.name))
  };
}

/**
 * ç”Ÿæˆç±»å‹å£°æ˜æ–‡ä»¶å†…å®¹
 * @param {Object} exports åŒ…å«ç»„ä»¶å’Œå‡½æ•°å¼ç»„ä»¶çš„å¯¹è±¡
 * @returns {string} ç”Ÿæˆçš„æ–‡ä»¶å†…å®¹
 */
function generateTypeDeclaration(exports) {
  const { components, functionComponents } = exports;
  
  const header = `/* eslint-disable */
/* prettier-ignore */
// @ts-nocheck
// Generated by generate-components-dts script
// Auto-generated Vue global components type declarations
export {}

declare module 'vue' {
  export interface GlobalComponents {`;

  const componentDeclarations = components.map(comp => {
    return `    ${comp.name}: typeof import('./types/components')['${comp.name}']`;
  }).join('\n');

  const vueModuleFooter = `  }
}

declare module '@vue/runtime-core' {
  export interface ComponentCustomProperties {`;

  const functionDeclarations = functionComponents.map(func => {
    // å°†UDialogFnè½¬æ¢ä¸º$dialogï¼ŒUMessageFnè½¬æ¢ä¸º$messageç­‰
    const propertyName = func.name.replace('U', '').replace('Fn', '').toLowerCase();
    return `    $${propertyName}: typeof import('./types/components')['${func.name}']`;
  }).join('\n');

  const footer = `  }
}`;

  return [header, componentDeclarations, vueModuleFooter, functionDeclarations, footer].join('\n');
}

/**
 * ä¸»å‡½æ•°
 */
async function main() {
  try {
    console.log('ğŸ” æ‰«æç»„ä»¶å¯¼å‡º...');
    
    // æ£€æŸ¥src/componentsç›®å½•æ˜¯å¦å­˜åœ¨
    if (!fs.existsSync(SRC_COMPONENTS_DIR)) {
      console.error(`âŒ é”™è¯¯: ${SRC_COMPONENTS_DIR} ç›®å½•ä¸å­˜åœ¨`);
      process.exit(1);
    }

    const exports = await scanComponentExports();
    
    if (exports.components.length === 0) {
      console.warn('âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ°ä»»ä½•ç»„ä»¶å¯¼å‡º');
      return;
    }

    console.log(`ğŸ“¦ æ‰¾åˆ° ${exports.components.length} ä¸ªç»„ä»¶:`);
    exports.components.forEach(comp => {
      console.log(`   - ${comp.name}`);
    });

    if (exports.functionComponents.length > 0) {
      console.log(`ğŸ”§ æ‰¾åˆ° ${exports.functionComponents.length} ä¸ªå‡½æ•°å¼ç»„ä»¶:`);
      exports.functionComponents.forEach(func => {
        console.log(`   - ${func.name}`);
      });
    }

    const content = generateTypeDeclaration(exports);
    
    // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    const outputDir = path.dirname(OUTPUT_FILE);
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }

    // å†™å…¥æ–‡ä»¶
    fs.writeFileSync(OUTPUT_FILE, content, 'utf8');
    
    // è®©ä¸»ç±»å‹å…¥å£å¼•ç”¨ u-blog-ui.d.tsï¼Œè¿™æ · instance.proxy ä¸Šæ‰æœ‰ $dialog / $message ç­‰ç±»å‹
    if (fs.existsSync(CORE_INDEX_DTS)) {
      let coreIndex = fs.readFileSync(CORE_INDEX_DTS, 'utf8');
      if (!coreIndex.includes('u-blog-ui.d.ts')) {
        coreIndex = U_BLOG_UI_REF + coreIndex;
        fs.writeFileSync(CORE_INDEX_DTS, coreIndex, 'utf8');
        console.log('âœ… å·²ä¸ºä¸»ç±»å‹å…¥å£æ·»åŠ å¯¹ u-blog-ui.d.ts çš„å¼•ç”¨');
      }
    }
    
    console.log(`âœ… æˆåŠŸç”Ÿæˆç»„ä»¶ç±»å‹å£°æ˜æ–‡ä»¶: ${OUTPUT_FILE}`);
    console.log(`ğŸ“„ æ–‡ä»¶å¤§å°: ${(content.length / 1024).toFixed(2)} KB`);
    
  } catch (error) {
    console.error('âŒ ç”Ÿæˆç»„ä»¶ç±»å‹å£°æ˜æ–‡ä»¶æ—¶å‡ºé”™:', error.message);
    process.exit(1);
  }
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬
if (process.argv[1] && process.argv[1].endsWith('generate-components-dts.js')) {
  main().catch(console.error);
}

export {
  scanComponentExports,
  generateTypeDeclaration,
  toPascalCase
};
